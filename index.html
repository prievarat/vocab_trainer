<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expressions Trainer</title>

  <!-- (Opcion√°lis) Tailwind CDN: ha bet√∂lt, minden Tailwind-oszt√°ly √©l;
       ha nem, a fallback CSS √≠gy is teljes diz√°jnt ad. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 100% Tailwind-mentes, √∂n√°ll√≥ st√≠lusok a biztos megjelen√©shez -->
  <style>
    /* ===== Alap tipogr√°fia ===== */
    :root { --slate-50:#f8fafc; --slate-100:#f1f5f9; --slate-200:#e2e8f0; --slate-500:#64748b; --slate-600:#475569; --slate-700:#334155; --slate-900:#0f172a;
            --indigo-50:#eef2ff; --indigo-500:#6366f1; --indigo-700:#3730a3; --green-100:#dcfce7; --red-100:#fee2e2; }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
         background:var(--slate-50); color:var(--slate-900);}
    /* ===== Gyakran haszn√°lt utilok (Tailwind n√©lk√ºl is) ===== */
    .max-w-6xl{max-width:72rem} .mx-auto{margin-left:auto;margin-right:auto}
    .p-3{padding:.75rem} .p-4{padding:1rem} .p-6{padding:1.5rem} .px-2{padding-left:.5rem;padding-right:.5rem}
    .py-1{padding-top:.25rem;padding-bottom:.25rem} .mt-1{margin-top:.25rem} .mt-2{margin-top:.5rem}
    .mt-3{margin-top:.75rem} .mt-4{margin-top:1rem} .mt-5{margin-top:1.25rem} .mb-5{margin-bottom:1.25rem}
    .gap-2{gap:.5rem} .gap-3{gap:.75rem} .gap-4{gap:1rem}
    .text-xs{font-size:.75rem;line-height:1rem} .text-sm{font-size:.875rem;line-height:1.25rem}
    .text-lg{font-size:1.125rem;line-height:1.75rem} .text-xl{font-size:1.25rem;line-height:1.75rem}
    .text-2xl{font-size:1.5rem;line-height:2rem} .font-semibold{font-weight:600} .font-bold{font-weight:700}
    .text-slate-500{color:var(--slate-500)} .text-slate-600{color:var(--slate-600)}
    .text-slate-700{color:var(--slate-700)} .text-slate-900{color:var(--slate-900)}
    .bg-white{background:#fff} .bg-slate-50{background:var(--slate-50)} .bg-slate-100{background:var(--slate-100)}
    .bg-indigo-50{background:var(--indigo-50)} .bg-green-100{background:var(--green-100)} .bg-red-100{background:var(--red-100)}
    .border{border:1px solid var(--slate-200)} .rounded-xl{border-radius:.75rem} .rounded-2xl{border-radius:1rem}
    .shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .flex{display:flex} .flex-col{flex-direction:column} .items-center{align-items:center}
    .items-start{align-items:flex-start} .justify-between{justify-content:space-between} .flex-wrap{flex-wrap:wrap}
    .w-px{width:1px} .h-8{height:2rem} .text-center{text-align:center}
    .grid{display:grid} .grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}
    .cursor-pointer{cursor:pointer} .hidden{display:none} .line-through{text-decoration:line-through}
    .w-full{width:100%} .h-2{height:.5rem}
    .bg-indigo-500{background:var(--indigo-500)} .text-indigo-700{color:var(--indigo-700)}
    .font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .select-none{-webkit-user-select:none;-moz-user-select:none;user-select:none}

    /* Respons√≠v r√©szletek (sm:) */
    @media (min-width:640px){
      .sm\:p-6{padding:1.5rem}
      .sm\:flex-row{flex-direction:row}
      .sm\:items-end{align-items:flex-end}
      .sm\:justify-between{justify-content:space-between}
      .sm\:w-64{width:16rem}
      .sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
      .sm\:text-3xl{font-size:1.875rem;line-height:2.25rem}
    }

    /* ===== Komponensek (Tailwind helyett k√©zzel) ===== */
    .card{background:#fff;border-radius:1rem;padding:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.5rem 1rem;
         font-weight:600;background:var(--slate-900);color:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:.1s}
    .btn:hover{filter:brightness(1.05)} .btn:active{transform:scale(.98)}
    .btn-sec{display:inline-flex;align-items:center;justify-content:center;border-radius:.75rem;padding:.4rem .75rem;
             font-weight:500;background:var(--slate-100);color:var(--slate-700)}
    .btn-sec:hover{background:var(--slate-200)}
    .tag{font-size:.75rem;padding:.125rem .5rem;border-radius:9999px;background:var(--slate-100);color:var(--slate-600)}
    .pill{font-size:.75rem;padding:.125rem .5rem;border-radius:9999px;background:var(--indigo-50);color:var(--indigo-700)}
    .mode-tab{padding:.5rem .75rem;border-radius:.75rem;cursor:pointer}
    .mode-tab.active{background:var(--slate-900);color:#fff}

    /* ===== Bingo r√°cs ===== */
    .grid-bingo{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
    .bingo-cell{border:1px solid var(--slate-200);border-radius:.75rem;padding:.75rem;font-size:.875rem;background:#fff;
      min-height:64px;display:flex;align-items:center;justify-content:center;text-align:center;cursor:pointer}
    .bingo-cell.used{background:var(--green-100);text-decoration:line-through}

    /* ===== Kiseg√≠t≈ë elemek ===== */
    .kbd{display:inline-block;padding:.125rem .5rem;font-size:.75rem;border-radius:.25rem;border:1px solid var(--slate-200);background:var(--slate-50)}
    .toast{position:fixed;left:50%;bottom:1rem;transform:translateX(-50%);background:var(--slate-900);color:#fff;
           padding:.5rem 1rem;border-radius:.75rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    .progress-bar{width:100%;height:.5rem;background:var(--slate-100);border-radius:9999px}
    .progress-fill{height:.5rem;background:var(--indigo-500);border-radius:9999px}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-5">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold">Expressions Trainer</h1>
        <p class="text-sm text-slate-600">44 c√©lkifejez√©s akt√≠v, j√°t√©kos be√©p√≠t√©s√©hez (EN‚ÜîHU)</p>
      </div>
      <div class="flex items-center gap-2">
        <div class="card p-3 flex items-center gap-3"><!-- !p-3 ‚Üí p-3 -->
          <div class="text-center">
            <div class="text-xs text-slate-500">Pontok</div>
            <div id="points" class="text-xl font-semibold">0</div>
          </div>
          <div class="w-px h-8" style="background:var(--slate-200)"></div>
          <div class="text-center">
            <div class="text-xs text-slate-500">Napi sorozat</div>
            <div id="streak" class="text-xl font-semibold">0</div>
          </div>
          <div class="w-px h-8" style="background:var(--slate-200)"></div>
          <div class="text-center">
            <div class="text-xs text-slate-500">Ismert k√°rty√°k</div>
            <div id="knownCount" class="text-xl font-semibold">0</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Napi kih√≠v√°s -->
    <section class="card mb-5" id="dailyBox">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xs uppercase tracking-wider text-slate-500">Napi kih√≠v√°s</div>
          <div id="dailyText" class="text-lg font-semibold"></div>
          <div class="mt-1 text-sm text-slate-600">Mondj egy r√∂vid mondatot ezzel a kifejez√©ssel. Jel√∂ld k√©szre, ha elmondtad.</div>
          <button id="btnDailyDone" class="btn-sec mt-3">Kih√≠v√°s teljes√≠tve</button>
        </div>
        <div class="text-right">
          <span id="clusterStatus" class="pill"></span>
        </div>
      </div>
    </section>

    <!-- F√ºlek -->
    <nav class="flex flex-wrap gap-2 mb-4" id="tabs">
      <button class="mode-tab active" data-mode="flash">Flashcards</button>
      <button class="mode-tab" data-mode="match">Matching</button>
      <button class="mode-tab" data-mode="mcq">Multiple Choice</button>
      <button class="mode-tab" data-mode="transform">Transformation</button>
      <button class="mode-tab" data-mode="prompt">Prompted Speaking</button>
      <button class="mode-tab" data-mode="bingo">Quick Fire / Bingo</button>
      <button class="mode-tab" data-mode="progress">Progress</button>
      <span class="ml-auto text-sm text-slate-500">Tippek: <span class="kbd">R</span> √∫jrat√∂lt / <span class="kbd">F</span> flip / <span class="kbd">K</span> I know</span>
    </nav>

    <!-- N√©zetek -->
    <main id="views" class="space-y-4">
      <!-- FLASHCARDS -->
      <section id="view-flash" class="card">
        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div class="text-sm text-slate-500">Akt√≠v pakli: <span id="flashCount">0</span> k√°rtya</div>
              <div class="flex items-center gap-2">
                <label class="text-sm">Oldal:
                  <select id="flashSide" class="border rounded-xl px-2 py-1 text-sm">
                    <option value="hu">HU ‚Üí EN</option>
                    <option value="en">EN ‚Üí HU</option>
                  </select>
                </label>
                <label class="text-sm">Klaszter:
                  <select id="clusterFilter" class="border rounded-xl px-2 py-1 text-sm"></select>
                </label>
              </div>
            </div>
            <div id="flashCard" class="mt-4 border rounded-2xl p-6 bg-indigo-50 cursor-pointer">
              <div id="flashFront" class="text-xl font-semibold"></div>
              <div id="flashBack" class="mt-2 text-slate-700 hidden"></div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="btnFlip" class="btn">Flip (F)</button>
              <button id="btnIKnow" class="btn-sec">I know (K)</button>
              <button id="btnKeep" class="btn-sec">Still studying</button>
              <button id="btnNext" class="btn-sec">Next (R)</button>
              <button id="btnResetKnown" class="btn-sec">Reset known for this cluster</button>
            </div>
          </div>
          <aside class="w-full sm:w-64">
            <div class="text-sm mb-2">Ismert k√°rty√°k ebben a klaszterben</div>
            <ul id="knownList" class="text-sm space-y-1" style="max-height:16rem;overflow:auto"></ul>
          </aside>
        </div>
      </section>

      <!-- MATCHING -->
      <section id="view-match" class="card hidden">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">P√°ros√≠tsd az 5 kifejez√©st (HU ‚Üî EN). Kattints egy HU elemre, majd a p√°rj√°ra.</div>
          <button id="btnNewMatch" class="btn-sec">√öj k√©szlet</button>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4" id="matchGrid"></div>
        <div id="matchMsg" class="mt-3 text-sm"></div>
      </section>

      <!-- MCQ -->
      <section id="view-mcq" class="card hidden">
        <div class="text-sm text-slate-600">V√°laszd ki, melyik jelent√©se illik a kiemelt kifejez√©shez.</div>
        <div class="mt-3" id="mcqBox"></div>
        <div class="mt-3 flex gap-2">
          <button id="btnNewMcq" class="btn-sec">√öj k√©rd√©s</button>
        </div>
      </section>

      <!-- TRANSFORMATION -->
      <section id="view-transform" class="card hidden">
        <div class="text-sm text-slate-600">√çrd √°t a mondatot a c√©lkifejez√©s haszn√°lat√°val. (R√©szben szabad megold√°s, t√∂bb j√≥ v√°lasz lehets√©ges.)</div>
        <div class="mt-3 space-y-3" id="transformBox"></div>
        <div class="mt-2"><button id="btnNewTransform" class="btn-sec">√öj feladat</button></div>
      </section>

      <!-- PROMPTED SPEAKING -->
      <section id="view-prompt" class="card hidden">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-600">Mondd el 45‚Äì60 m√°sodpercben. Pip√°ld ki, amit haszn√°lt√°l.</div>
            <div id="promptTopic" class="text-lg font-semibold mt-1"></div>
          </div>
          <div class="text-sm"><span id="promptTimer" class="font-mono">00:60</span></div>
        </div>
        <div id="promptExpr" class="mt-3 flex flex-wrap gap-2"></div>
        <div class="mt-3 flex gap-2">
          <button id="btnStartPrompt" class="btn">Start</button>
          <button id="btnNewPrompt" class="btn-sec">√öj t√©ma</button>
        </div>
      </section>

      <!-- BINGO -->
      <section id="view-bingo" class="card hidden">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">C√©l: mind a 9 kifejez√©st haszn√°ld besz√©lget√©s k√∂zben. Kattints, ha haszn√°ltad.</div>
          <button id="btnNewBingo" class="btn-sec">√öj t√°bla</button>
        </div>
        <div id="bingoGrid" class="grid-bingo mt-3"></div>
      </section>

      <!-- PROGRESS -->
      <section id="view-progress" class="card hidden">
        <h2 class="font-semibold mb-2">Halad√°s √©s felold√°sok</h2>
        <div id="progressList" class="space-y-2"></div>
        <div class="mt-4 text-sm text-slate-600">Felold√°si szab√°ly: egy klaszter √∫jk√©nt el√©rhet≈ë, ha az el≈ëz≈ëben az elemek ‚â• 70%-√°t ‚ÄûI know‚Äù jel√∂lted.</div>
      </section>
    </main>

    <footer class="text-center text-xs text-slate-500 mt-5">
      Made for classroom use ‚Ä¢ Stores progress locally in your browser ‚Ä¢ v1.0
    </footer>
  </div>

  <script>
    /*************** DATA ***************/
    const EXPRESSIONS = [
      {id:'e1',  en:"I‚Äôm not sure what/where/why exactly.", hu:"nem tudom, pontosan mit/hol/mi√©rt ‚Ä¶", cluster:"opinions"},
      {id:'e2',  en:"His main interest is ‚Ä¶", hu:"f≈ë √©rdekl≈ëd√©si k√∂re ‚Ä¶", cluster:"family"},
      {id:'e3',  en:"A lot of people get divorced and live on their own, and bring up their children on their own.", hu:"Sokan elv√°lnak, egyed√ºl √©lnek, √©s a gyerekeiket is egyed√ºl nevelik.", cluster:"family"},
      {id:'e4',  en:"‚Ä¶ which means ‚Ä¶", hu:"ami azt jelenti, hogy ‚Ä¶", cluster:"linkers"},
      {id:'e5',  en:"He ‚Ä¶ for a living.", hu:"vmit csin√°l a meg√©lhet√©s√©rt / √©l vmib≈ël", cluster:"work"},
      {id:'e6',  en:"But I only have very vague memories of her.", hu:"De csak nagyon halv√°ny eml√©keim vannak r√≥la.", cluster:"childhood"},
      {id:'e7',  en:"I come from quite a big family.", hu:"El√©g nagy csal√°db√≥l sz√°rmazom.", cluster:"family"},
      {id:'e8',  en:"However.", hu:"de / azonban", cluster:"linkers"},
      {id:'e9',  en:"I suppose.", hu:"azt hiszem / gondolom", cluster:"opinions"},
      {id:'e10', en:"As I remember ‚Ä¶", hu:"amennyire eml√©kszem / ha j√≥l eml√©kszem", cluster:"memory"},
      {id:'e11', en:"It was a lot better than ‚Ä¶", hu:"sokkal jobb volt, mint ‚Ä¶", cluster:"comparison"},
      {id:'e12', en:"Normally.", hu:"√°ltal√°ban", cluster:"frequency"},
      {id:'e13', en:"By the way ‚Ä¶", hu:"mellesleg", cluster:"linkers"},
      {id:'e14', en:"I have a lot of presents to buy at Christmas.", hu:"Sok aj√°nd√©kot kell vennem kar√°csonykor.", cluster:"everyday"},
      {id:'e15', en:"They were around my age.", hu:"kb. velem egykor√∫ak voltak.", cluster:"people"},
      {id:'e16', en:"They lived in the country for a while.", hu:"Vid√©ken √©ltek egy ideig.", cluster:"places"},
      {id:'e17', en:"Nowadays ‚Ä¶", hu:"manaps√°g", cluster:"time"},
      {id:'e18', en:"I don‚Äôt have a very close contact with ‚Ä¶", hu:"nincs szoros kapcsolatom ‚Ä¶-val/vel", cluster:"relationships"},
      {id:'e19', en:"He/She is the breadwinner in the family.", hu:"≈ê a keny√©rkeres≈ë a csal√°dban.", cluster:"family"},
      {id:'e20', en:"It sounds really nice.", hu:"Ez igaz√°n j√≥l hangzik.", cluster:"opinions"},
      {id:'e21', en:"I started to get my independence and lived my own life a bit.", hu:"Kezdtem √∂n√°ll√≥ lenni, √©s a saj√°t √©letemet √©lni.", cluster:"growing"},
      {id:'e22', en:"Occasionally.", hu:"n√©ha", cluster:"frequency"},
      {id:'e23', en:"The family atmosphere is/was mostly very happy.", hu:"Nagyj√°b√≥l mindig j√≥ volt a hangulat a csal√°dban.", cluster:"family"},
      {id:'e24', en:"During my early childhood ‚Ä¶", hu:"kora gyermekkoromban", cluster:"childhood"},
      {id:'e25', en:"Things were never really the same after that.", hu:"Azut√°n semmi sem volt m√°r ugyanolyan.", cluster:"memory"},
      {id:'e26', en:"I must admit ‚Ä¶", hu:"be kell vallanom / ismernem", cluster:"opinions"},
      {id:'e27', en:"In my growing years ‚Ä¶", hu:"fiatalkoromban", cluster:"growing"},
      {id:'e28', en:"We didn‚Äôt get on so well a lot of times.", hu:"Sokszor nem j√∂tt√ºnk ki valami j√≥l.", cluster:"relationships"},
      {id:'e29', en:"Every other week.", hu:"minden m√°sodik h√©ten", cluster:"time"},
      {id:'e30', en:"She seems to spend half of her life ‚Ä¶ (in the kitchen / cooking).", hu:"F√©l √©let√©t (f≈ëz√©ssel) t√∂lti.", cluster:"everyday"},
      {id:'e31', en:"‚Ä¶ which was a bit disappointing for me.", hu:"ami el√©g ki√°br√°nd√≠t√≥ volt", cluster:"feelings"},
      {id:'e32', en:"Actually ‚Ä¶", hu:"√∂√∂√∂√∂ / h√°t / igaz√°b√≥l", cluster:"fillers"},
      {id:'e33', en:"We have a lot of things in common / we have nothing in common.", hu:"Sok/semmi k√∂z√∂s nincs benn√ºnk.", cluster:"relationships"},
      {id:'e34', en:"He was not in the least interested in ‚Ä¶", hu:"legkev√©sb√© sem √©rdekelte ‚Ä¶", cluster:"opinions"},
      {id:'e35', en:"As far as I know ‚Ä¶", hu:"m√°r amennyire √©n tudom ‚Ä¶", cluster:"opinions"},
      {id:'e36', en:"He lived a very routine life.", hu:"Nagyon egyhang√∫ √©letet √©lt.", cluster:"everyday"},
      {id:'e37', en:"I organised for him to go to Spain.", hu:"Elint√©ztem neki, hogy Spanyolorsz√°gba utazzon.", cluster:"stories"},
      {id:'e38', en:"‚Ä¶ which was really fascinating.", hu:"ami leny≈±g√∂z≈ë volt", cluster:"feelings"},
      {id:'e39', en:"I suppose he is not just a sociable type.", hu:"Nem t√∫l bar√°tkoz√≥s t√≠pus.", cluster:"people"},
      {id:'e40', en:"I would say that ‚Ä¶", hu:"azt mondan√°m, hogy ‚Ä¶", cluster:"opinions"},
      {id:'e41', en:"He gets completely lost in his books.", hu:"Teljesen belemer√ºl a k√∂nyveibe.", cluster:"people"},
      {id:'e42', en:"They really take care of each other.", hu:"Nagyon gondoskodnak egym√°sr√≥l.", cluster:"relationships"},
      {id:'e43', en:"One of my dreams is to be happily married to a ripe old age.", hu:"√Ålmom a boldog, hossz√∫ h√°zass√°g.", cluster:"dreams"},
      {id:'e44', en:"So they say.", hu:"Legal√°bbis ezt mondj√°k.", cluster:"fillers"},
    ];

    const SPEAKING_TOPICS = [
      "Tell me about your family and childhood.",
      "Describe someone in your family.",
      "Talk about changes in your life.",
      "Share a story about a trip or plan.",
      "What is your daily routine like nowadays?",
      "What are your hopes and dreams about relationships?",
    ];

    const TRANSFORMS = [
      {src:"He works as a driver.", must:"for a living", targetExample:"He drives for a living."},
      {src:"I don‚Äôt remember much about my grandmother.", must:"vague memories", targetExample:"I only have very vague memories of my grandmother."},
      {src:"To be honest, I think he isn‚Äôt very friendly.", must:"I would say", targetExample:"I would say that he isn‚Äôt very sociable."},
      {src:"We are similar in many ways.", must:"in common", targetExample:"We have a lot of things in common."},
      {src:"She usually cooks.", must:"seems to spend", targetExample:"She seems to spend half of her life in the kitchen."},
      {src:"After that, everything changed.", must:"never really the same", targetExample:"Things were never really the same after that."},
      {src:"People say it‚Äôs true.", must:"so they say", targetExample:"It‚Äôs true, so they say."},
      {src:"Usually, we have a happy atmosphere.", must:"mostly very happy", targetExample:"The family atmosphere is mostly very happy."},
    ];

    /*************** STATE ***************/
    const LS = {
      get known(){ return new Set(JSON.parse(localStorage.getItem('knownExpr')||'[]')); },
      set knownSet(set){ localStorage.setItem('knownExpr', JSON.stringify([...set])); },
      get points(){ return +localStorage.getItem('points')||0; },
      set points(v){ localStorage.setItem('points', v); },
      get last(){ return localStorage.getItem('lastPractice')||''; },
      set last(s){ localStorage.setItem('lastPractice', s); },
      get streak(){ return +localStorage.getItem('streak')||0; },
      set streak(v){ localStorage.setItem('streak', v); },
      get unlocked(){ return new Set(JSON.parse(localStorage.getItem('unlockedClusters')||'[]')); },
      set unlockedSet(set){ localStorage.setItem('unlockedClusters', JSON.stringify([...set])); },
      get dailyDone(){ return localStorage.getItem('dailyDone')===todayStr(); },
      setDailyDone(){ localStorage.setItem('dailyDone', todayStr()); }
    };

    const CLUSTERS = (()=>{
      const map = new Map();
      EXPRESSIONS.forEach(e=>{
        if(!map.has(e.cluster)) map.set(e.cluster, []);
        map.get(e.cluster).push(e);
      });
      return map;
    })();

    (function initUnlock(){
      const defaultOpen = ['family','opinions'];
      const set = LS.unlocked; defaultOpen.forEach(c=>set.add(c)); LS.unlockedSet = set;
    })();

    function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

    function updateStreak(){
      const last = LS.last, today = todayStr();
      if(last!==today){
        if(last){
          const y = new Date(last), t = new Date(today);
          const diff = Math.round((t - y)/(1000*3600*24));
          LS.streak = (diff===1) ? (LS.streak + 1) : 1;
        } else { LS.streak = 1; }
        LS.last = today;
      }
      document.getElementById('streak').textContent = LS.streak;
    }

    function addPoints(n){ LS.points = LS.points + n; document.getElementById('points').textContent = LS.points; }
    function refreshKnown(){ const known = LS.known; document.getElementById('knownCount').textContent = known.size; }
    function clusterList(){ return [...CLUSTERS.keys()].sort(); }
    function unlockedClusters(){ return [...LS.unlocked].filter(c=>CLUSTERS.has(c)); }

    function clusterProgress(cluster){
      const arr = CLUSTERS.get(cluster)||[]; const known = LS.known;
      const k = arr.filter(e=>known.has(e.id)).length; const total = arr.length;
      const pct = total? Math.round(100*k/total):0;
      return {k, total, pct};
    }

    function maybeUnlockNext(){
      const list = clusterList();
      const set = LS.unlocked;
      for(let i=0;i<list.length-1;i++){
        const c = list[i]; const n = list[i+1];
        if(set.has(c) && !set.has(n)){
          const {pct} = clusterProgress(c);
          if(pct>=70){ set.add(n); LS.unlockedSet = set; toast(`New cluster unlocked: ${n}`); }
        }
      }
      renderProgress(); renderClusterStatus(); fillClusterFilter();
    }

    function renderClusterStatus(){
      const uc = unlockedClusters();
      document.getElementById('clusterStatus').textContent =
        uc.length? `Unlocked clusters: ${uc.join(', ')}` : 'No clusters unlocked yet';
    }

    /*************** FLASHCARDS ***************/
    let flashDeck = []; let flashIdx = 0; let flashFlipped=false;

    function fillClusterFilter(){
      const sel = document.getElementById('clusterFilter'); sel.innerHTML='';
      const optAll = document.createElement('option'); optAll.value='all'; optAll.textContent='All'; sel.appendChild(optAll);
      clusterList().forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent = LS.unlocked.has(c)? c : `${c} (locked)`; sel.appendChild(o);
      });
    }

    function buildFlashDeck(){
      const side = document.getElementById('flashSide').value;
      const cluster = document.getElementById('clusterFilter').value;
      const known = LS.known;
      let arr = EXPRESSIONS.filter(e=> cluster==='all' ? true : e.cluster===cluster);
      flashDeck = arr.filter(e=>!known.has(e.id));
      shuffle(flashDeck); flashIdx = 0; flashFlipped=false; renderFlash();
      const list = document.getElementById('knownList'); list.innerHTML='';
      arr.filter(e=>known.has(e.id)).forEach(e=>{
        const li=document.createElement('li'); li.textContent = (side==='hu'? e.hu : e.en); list.appendChild(li);
      });
      document.getElementById('flashCount').textContent = flashDeck.length;
    }

    function renderFlash(){
      const front = document.getElementById('flashFront');
      const back = document.getElementById('flashBack');
      if(!flashDeck.length){
        front.textContent = 'üéâ Minden k√°rty√°t ‚ÄûI know‚Äù-ra jel√∂lt√©l ebben a klaszterben!';
        back.classList.add('hidden'); back.textContent=''; return;
      }
      const side = document.getElementById('flashSide').value;
      const e = flashDeck[flashIdx];
      front.textContent = side==='hu'? e.hu : e.en;
      back.textContent  = side==='hu'? e.en : e.hu;
      back.classList.toggle('hidden', !flashFlipped);
    }

    function flipFlash(){ flashFlipped = !flashFlipped; renderFlash(); }
    function nextFlash(){ if(!flashDeck.length) return; flashIdx=(flashIdx+1)%flashDeck.length; flashFlipped=false; renderFlash(); }
    function markIKnow(){
      if(!flashDeck.length) return; const e = flashDeck[flashIdx];
      const known = LS.known; known.add(e.id); LS.knownSet = known; addPoints(5); refreshKnown();
      flashDeck.splice(flashIdx,1); if(flashIdx>=flashDeck.length) flashIdx=0; renderFlash(); maybeUnlockNext();
    }

    function resetKnownCluster(){
      const cluster = document.getElementById('clusterFilter').value;
      if(cluster==='all') { alert('V√°lassz klasztert a resethez.'); return; }
      const ids = new Set((CLUSTERS.get(cluster)||[]).map(e=>e.id));
      const known = LS.known; ids.forEach(id=> known.delete(id)); LS.knownSet = known; refreshKnown(); buildFlashDeck(); renderProgress();
    }

    /*************** MATCHING ***************/
    let matchPairs = []; let matchSel = null; let matchedCount=0;

    function newMatch(){
      const pool = unlockedPools();
      matchPairs = sample(pool, 5);
      matchedCount=0; matchSel=null;
      const left = matchPairs.map(e=>({id:e.id, text:e.hu, side:'hu'}));
      const right = matchPairs.map(e=>({id:e.id, text:e.en, side:'en'}));
      shuffle(left); shuffle(right);
      const grid = document.getElementById('matchGrid'); grid.innerHTML='';
      const colL = document.createElement('div'); colL.className = 'space-y-2';
      left.forEach(item=> colL.appendChild(matchItem(item)));
      const colR = document.createElement('div'); colR.className = 'space-y-2';
      right.forEach(item=> colR.appendChild(matchItem(item)));
      grid.appendChild(colL); grid.appendChild(colR);
      document.getElementById('matchMsg').textContent='';
    }

    function matchItem(item){
      const div = document.createElement('div');
      div.className='border rounded-xl p-3 bg-white cursor-pointer';
      div.textContent=item.text; div.dataset.id=item.id; div.dataset.side=item.side;
      div.addEventListener('click', ()=> selectMatch(div));
      return div;
    }

    function selectMatch(el){
      if(el.classList.contains('opacity-40')) return;
      if(!matchSel){ matchSel = el; el.style.outline='2px solid #818cf8'; el.style.outlineOffset='2px'; return; }
      if(matchSel===el){ matchSel.style.outline='none'; matchSel=null; return; }
      if(matchSel.dataset.id===el.dataset.id && matchSel.dataset.side!==el.dataset.side){
        matchSel.classList.add('opacity-40'); el.classList.add('opacity-40');
        matchSel.style.outline='none'; matchSel=null; matchedCount++; addPoints(3);
        if(matchedCount===matchPairs.length){ document.getElementById('matchMsg').textContent='‚úî K√©sz!'; addPoints(5); }
      } else {
        shake(el); shake(matchSel); matchSel.style.outline='none'; matchSel=null;
      }
    }

    /*************** MCQ ***************/
    function newMcq(){
      const pool = unlockedPools();
      const q = randomChoice(pool);
      const opts = uniqueSample(pool, 4, q);
      const box = document.getElementById('mcqBox');
      box.innerHTML = '';
      const qEl = document.createElement('div'); qEl.className='text-xl font-semibold'; qEl.textContent = q.hu; box.appendChild(qEl);
      const group = document.createElement('div'); group.className='mt-3 grid sm:grid-cols-2 gap-2';
      opts.forEach(o=>{
        const b=document.createElement('button'); b.className='btn-sec text-left'; b.textContent=o.en; b.addEventListener('click', ()=>{
          if(o.id===q.id){ b.classList.add('bg-green-100'); addPoints(2); toast('Correct'); }
          else { b.classList.add('bg-red-100'); shake(b); }
        }); group.appendChild(b);
      });
      box.appendChild(group);
    }

    /*************** TRANSFORMATION ***************/
    function newTransform(){
      const t = randomChoice(TRANSFORMS);
      const box = document.getElementById('transformBox');
      box.innerHTML='';
      const src = document.createElement('div'); src.className='text-lg font-semibold'; src.textContent = 'Rewrite: ' + t.src; box.appendChild(src);
      const must = document.createElement('div'); must.className='text-sm text-slate-500'; must.textContent = `Use: ‚Äú${t.must}‚Äù`; box.appendChild(must);
      const inp = document.createElement('textarea'); inp.className='w-full border rounded-xl p-3 mt-2'; inp.rows=3; box.appendChild(inp);
      const row = document.createElement('div'); row.className='mt-2 flex gap-2';
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Check';
      const hint = document.createElement('button'); hint.className='btn-sec'; hint.textContent='Show example';
      const msg = document.createElement('div'); msg.className='text-sm mt-2';
      row.appendChild(btn); row.appendChild(hint); box.appendChild(row); box.appendChild(msg);
      btn.addEventListener('click', ()=>{
        const ok = inp.value.toLowerCase().includes(t.must.toLowerCase());
        if(ok){ msg.textContent='‚úî Looks good!'; addPoints(4); } else { msg.textContent='Try to include the target phrase.'; shake(inp); }
      });
      hint.addEventListener('click', ()=>{ alert('Example: '+t.targetExample); });
    }

    /*************** PROMPTED SPEAKING ***************/
    let promptTimer=null; let remaining=60;
    function newPrompt(){
      const topic = randomChoice(SPEAKING_TOPICS);
      const picked = uniqueSample(unlockedPools(), 3);
      document.getElementById('promptTopic').textContent = topic;
      const cont = document.getElementById('promptExpr'); cont.innerHTML='';
      picked.forEach(p=>{
        const chip = document.createElement('button'); chip.className='btn-sec'; chip.textContent=p.en; chip.addEventListener('click', ()=> chip.classList.toggle('bg-green-100'));
        cont.appendChild(chip);
      });
      resetTimer();
    }
    function resetTimer(){ clearInterval(promptTimer); remaining=60; renderTimer(); }
    function startPrompt(){ resetTimer(); promptTimer = setInterval(()=>{ remaining--; renderTimer(); if(remaining<=0){ clearInterval(promptTimer); addPoints(5); toast('Time!'); } }, 1000); }
    function renderTimer(){ document.getElementById('promptTimer').textContent = `00:${String(Math.max(0,remaining)).padStart(2,'0')}`; }

    /*************** BINGO ***************/
    function newBingo(){
      const grid = document.getElementById('bingoGrid'); grid.innerHTML='';
      const items = uniqueSample(unlockedPools(), 9);
      items.forEach(it=>{
        const c=document.createElement('div'); c.className='bingo-cell'; c.textContent=it.en; c.addEventListener('click',()=>{ c.classList.toggle('used'); checkBingoWin(); }); grid.appendChild(c);
      });
    }
    function checkBingoWin(){
      const cells=[...document.querySelectorAll('#bingoGrid .bingo-cell')];
      const used=cells.filter(c=>c.classList.contains('used')).length;
      if(used===9){ toast('Bingo! Great job using all 9.'); addPoints(10); }
    }

    /*************** PROGRESS ***************/
    function renderProgress(){
      const box=document.getElementById('progressList'); box.innerHTML='';
      clusterList().forEach(c=>{
        const {k,total,pct} = clusterProgress(c);
        const wrap=document.createElement('div'); wrap.className='border rounded-xl p-3 bg-white flex items-center justify-between';
        const left=document.createElement('div'); left.innerHTML=`<div class="font-medium">${c}</div><div class="text-xs text-slate-500">${LS.unlocked.has(c)?'unlocked':'locked'}</div>`;
        const right=document.createElement('div'); right.innerHTML=`<div class="text-sm">${k}/${total} (${pct}%)</div>`;
        const bar=document.createElement('div'); bar.className='progress-bar mt-2';
        const fill=document.createElement('div'); fill.className='progress-fill'; fill.style.width=pct+'%'; bar.appendChild(fill);
        const col=document.createElement('div'); col.appendChild(left); col.appendChild(bar);
        wrap.innerHTML=''; wrap.appendChild(col); wrap.appendChild(right); box.appendChild(wrap);
      });
    }

    /*************** DAILY ***************/
    function buildDaily(){
      const seed = Number(todayStr().replaceAll('-',''));
      const rng = mulberry32(seed);
      const pool = unlockedPools();
      const pick = pool[Math.floor(rng()*pool.length)] || EXPRESSIONS[0];
      document.getElementById('dailyText').textContent = `Use: ‚Äú${pick.en}‚Äù`;
      document.getElementById('btnDailyDone').onclick = ()=>{ if(!LS.dailyDone){ addPoints(5); LS.setDailyDone(); toast('Daily done!'); } };
    }

    /*************** HELPERS ***************/
    function unlockedPools(){ const set = LS.unlocked; return EXPRESSIONS.filter(e=>set.has(e.cluster)); }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j]], a[j]; } return a; }
    function sample(arr, n){ const c=[...arr]; shuffle(c); return c.slice(0, Math.min(n, c.length)); }
    function uniqueSample(arr, n, ensure){ const c=[...arr]; if(ensure){ c.splice(c.indexOf(ensure),1); } shuffle(c); const out = ensure? [ensure]:[]; while(out.length<n && c.length){ out.push(c.shift()); } return shuffle(out); }
    function randomChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function mulberry32(a){
      let t = a >>> 0;
      return function(){
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
      };
    }

    function toast(msg){
      const el=document.createElement('div'); el.className='toast'; el.textContent=msg;
      document.body.appendChild(el); setTimeout(()=> el.remove(), 1600);
    }
    function shake(el){ if(!el) return; el.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:200}); }

    function keyShortcuts(){
      document.addEventListener('keydown', (e)=>{
        if(e.key==='f' || e.key==='F') flipFlash();
        if(e.key==='k' || e.key==='K') markIKnow();
        if(e.key==='r' || e.key==='R') nextFlash();
      });
    }

    /*************** TABS ***************/
    function switchTo(mode){
      document.querySelectorAll('.mode-tab').forEach(t=> t.classList.toggle('active', t.dataset.mode===mode));
      document.querySelectorAll('[id^="view-"]').forEach(v=> v.classList.add('hidden'));
      document.getElementById('view-'+mode).classList.remove('hidden');
      if(mode==='flash'){ buildFlashDeck(); }
      if(mode==='match'){ newMatch(); }
      if(mode==='mcq'){ newMcq(); }
      if(mode==='transform'){ newTransform(); }
      if(mode==='prompt'){ newPrompt(); }
      if(mode==='bingo'){ newBingo(); }
      if(mode==='progress'){ renderProgress(); }
    }

    /*************** INIT ***************/
    function init(){
      document.getElementById('points').textContent = LS.points;
      refreshKnown(); updateStreak(); fillClusterFilter(); renderClusterStatus(); buildDaily();

      document.getElementById('flashCard').addEventListener('click', flipFlash);
      document.getElementById('btnFlip').addEventListener('click', flipFlash);
      document.getElementById('btnIKnow').addEventListener('click', markIKnow);
      document.getElementById('btnKeep').addEventListener('click', nextFlash);
      document.getElementById('btnNext').addEventListener('click', nextFlash);
      document.getElementById('flashSide').addEventListener('change', buildFlashDeck);
      document.getElementById('clusterFilter').addEventListener('change', buildFlashDeck);
      document.getElementById('btnResetKnown').addEventListener('click', resetKnownCluster);

      document.getElementById('btnNewMatch').addEventListener('click', newMatch);
      document.getElementById('btnNewMcq').addEventListener('click', newMcq);
      document.getElementById('btnNewTransform').addEventListener('click', newTransform);

      document.getElementById('btnStartPrompt').addEventListener('click', startPrompt);
      document.getElementById('btnNewPrompt').addEventListener('click', newPrompt);

      document.getElementById('btnNewBingo').addEventListener('click', newBingo);

      document.querySelectorAll('.mode-tab').forEach(b=> b.addEventListener('click', ()=> switchTo(b.dataset.mode)));
      keyShortcuts();

      switchTo('flash');
    }
    window.addEventListener('load', init);
  </script>
</body>
</html>
