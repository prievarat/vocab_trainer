<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Expressions Trainer – HU ⇄ EN (v3)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
    --primary:#2563eb; --primary-2:#1d4ed8; --ok:#16a34a; --bad:#dc2626;
    --warn:#d97706; --card:#0b1220; --border:#22304b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);
       background:linear-gradient(180deg,#0b1020 0%,#0f172a 100%);}
  a{color:#93c5fd}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{padding:12px 0 8px 0}
  h1{font-size:22px;margin:0 0 8px 0}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .select,.btn,input[type="text"],textarea{background:var(--panel);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:10px 12px;font-size:14px}
  .btn{cursor:pointer;user-select:none}
  .btn.primary{background:var(--primary);border-color:transparent}
  .btn.primary:hover{background:var(--primary-2)}
  .btn.ghost{background:transparent;border-color:var(--border)}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.bad{background:var(--bad);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0 12px 0}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer}
  .tab.active{background:var(--primary);border-color:transparent}
  .panel{display:none;background:rgba(17,24,39,.5);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:16px}
  .panel.active{display:block}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .between{display:flex;justify-content:space-between;align-items:center}
  .grow{flex:1}
  .muted{color:var(--muted)}
  .pill{background:#111827;border:1px solid var(--border);border-radius:14px;padding:4px 10px;font-size:12px}
  .grid{display:grid;gap:10px}
  .card{border:1px solid var(--border);border-radius:14px;background:var(--card);padding:18px;min-height:64px;display:flex;align-items:center;justify-content:center;text-align:center}
  .small{font-size:12px}
  .center{text-align:center}
  .hidden{display:none !important}
  .columns{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .item{padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer;min-height:52px;display:flex;align-items:center;justify-content:center;text-align:center}
  .item.selected{outline:2px solid var(--primary)}
  .item.correct{background:#0b3b1e;border-color:#155e2e}
  .item.wrong{background:#4a1010;border-color:#7f1d1d}
  .qf-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .tile{padding:14px;border:1px solid var(--border);border-radius:12px;background:var(--panel);cursor:pointer;min-height:72px;display:flex;align-items:center;justify-content:center;text-align:center}
  .tile.hit{background:#0b3b1e;border-color:#155e2e}
  .tile.miss{animation:shake .2s both}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-2px)}100%{transform:translateX(0)}}
  .timer{font-variant-numeric:tabular-nums;font-size:20px}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
  .sep{height:1px;background:var(--border);margin:10px 0}
  .prompt{padding:14px;border-radius:10px;background:var(--panel);border:1px solid var(--border);text-align:center}
  .chip{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0f1a30;margin:4px 4px 0 0;font-size:13px;cursor:pointer;user-select:none}
  .chip.used{text-decoration:line-through;opacity:.6}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Expressions Trainer (HU ⇄ EN) — v3</h1>
    <div class="bar">
      <label>Oldal:
        <select id="side" class="select">
          <option value="hu-en">HU → EN</option>
          <option value="en-hu">EN → HU</option>
        </select>
      </label>
      <label>Klaszter:
        <select id="cluster" class="select">
          <option value="all">All</option>
        </select>
      </label>
      <button id="resetKnownCluster" class="btn warn">Reset known for this cluster</button>
      <span class="pill">Billentyűk: <span class="muted">F=Flip, K=I know, R=Next</span></span>
      <span class="muted small">Adatok helyi tárolóban (LocalStorage)</span>
    </div>
  </header>

  <nav class="tabs" id="tabs">
    <div class="tab active" data-tab="flash">Flashcards</div>
    <div class="tab" data-tab="matching">Matching</div>
    <div class="tab" data-tab="mc">Multiple Choice</div>
    <div class="tab" data-tab="transform">Transformation</div>
    <div class="tab" data-tab="speaking">Prompted Speaking</div>
    <div class="tab" data-tab="quick">Quick Fire / Bingo</div>
    <div class="tab" data-tab="progress">Progress</div>
  </nav>

  <!-- Flashcards -->
  <section class="panel active" id="panel-flash">
    <div class="between">
      <div class="muted">Aktív pakli: <span id="flash-count">0</span> kártya</div>
      <div class="muted">Ismert kártyák a klaszterben: <span id="known-count">0</span></div>
    </div>
    <div id="flash-card" class="card" style="min-height:120px;margin:12px 0;">
      <div class="grow center">
        <div id="flash-front" style="font-size:22px;font-weight:600">—</div>
        <div id="flash-back" class="hidden" style="margin-top:8px;font-size:18px;color:#cbd5e1">—</div>
      </div>
    </div>
    <div class="row">
      <button class="btn primary" id="flash-flip">Flip (F)</button>
      <button class="btn ok" id="flash-know">I know (K)</button>
      <button class="btn ghost" id="flash-keep">Still studying</button>
      <button class="btn" id="flash-next">Next (R)</button>
    </div>
  </section>

  <!-- Matching -->
  <section class="panel" id="panel-matching">
    <div class="muted small">Párosítsd a megfelelőket. 6 pár / kör.</div>
    <div class="columns" style="margin:12px 0;">
      <div id="match-left" class="col"></div>
      <div id="match-right" class="col"></div>
    </div>
    <div class="row">
      <button id="match-reset" class="btn">Újrakezd</button>
      <button id="match-next" class="btn primary">Új kör</button>
      <span class="pill">Helyes: <span id="match-correct">0</span></span>
      <span class="pill">Hibák: <span id="match-wrong">0</span></span>
    </div>
  </section>

  <!-- Multiple Choice -->
  <section class="panel" id="panel-mc">
    <div class="prompt" id="mc-prompt">—</div>
    <div class="grid" id="mc-answers" style="grid-template-columns:repeat(2,1fr);margin-top:10px"></div>
    <div class="row" style="margin-top:10px">
      <button id="mc-next" class="btn primary">Következő</button>
      <span class="pill">Helyes: <span id="mc-correct">0</span></span>
      <span class="pill">Összes: <span id="mc-total">0</span></span>
    </div>
  </section>

  <!-- Transformation -->
  <section class="panel" id="panel-transform">
    <div class="prompt" id="tr-prompt">—</div>
    <div class="row" style="margin-top:10px">
      <input type="text" id="tr-input" class="grow" placeholder="Írd be a fordítást…" />
      <button id="tr-check" class="btn primary">Ellenőrzés</button>
      <button id="tr-next" class="btn">Következő</button>
    </div>
    <div id="tr-feedback" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Prompted Speaking -->
  <section class="panel" id="panel-speaking">
    <div class="between">
      <div class="prompt grow" id="sp-prompt">—</div>
      <div class="row" style="min-width:210px; margin-left:10px">
        <button id="sp-start" class="btn primary">Start 60s</button>
        <button id="sp-stop" class="btn">Stop</button>
        <div class="pill"><span class="muted">⏱</span> <span id="sp-timer" class="mono">60</span></div>
      </div>
    </div>
    <div id="sp-exprs" class="muted small center" style="margin-top:8px"></div>
    <div class="row" style="margin-top:10px">
      <button id="sp-done" class="btn ok">Elmondtam</button>
      <button id="sp-next" class="btn">Új kártya</button>
    </div>
    <div id="sp-tip" class="muted small" style="margin-top:8px">
      Feladat: válaszolj a kérdésre / teljesítsd az utasítást, és <b>használj 3 megadott kifejezést</b> a válaszodban. (Kattints a kifejezésekre, ha <u>felhasználtad</u> – áthúzza. Billentyűk: 1–3.)
    </div>
  </section>

  <!-- Quick Fire / Bingo -->
  <section class="panel" id="panel-quick">
    <div class="between">
      <div class="row">
        <button id="qf-start" class="btn primary">Start (60s)</button>
        <span class="pill">Pont: <span id="qf-score">0</span></span>
        <span class="pill">Találat: <span id="qf-hits">0</span>/12</span>
      </div>
      <div class="timer" id="qf-timer">60</div>
    </div>
    <div class="prompt" id="qf-prompt" style="margin-top:10px">Kezdéshez kattints a Start gombra.</div>
    <div class="qf-grid" id="qf-grid" style="margin-top:12px"></div>
  </section>

  <!-- Progress -->
  <section class="panel" id="panel-progress">
    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
      <div class="card"><div><div class="muted small">Ismert kártyák (összes)</div><div id="pg-known" style="font-size:22px" class="mono">0</div></div></div>
      <div class="card"><div><div class="muted small">Flashcards – megtekintve</div><div id="pg-flash" style="font-size:22px" class="mono">0</div></div></div>
      <div class="card"><div><div class="muted small">Matching – helyes/hibás</div><div id="pg-match" style="font-size:22px" class="mono">0 / 0</div></div></div>
      <div class="card"><div><div class="muted small">Multiple Choice – helyes/összes</div><div id="pg-mc" style="font-size:22px" class="mono">0 / 0</div></div></div>
      <div class="card"><div><div class="muted small">Quick Fire – rekord pont</div><div id="pg-qf" style="font-size:22px" class="mono">0</div></div></div>
    </div>
    <div class="sep"></div>
    <div id="pg-clusters"></div>
  </section>

  <footer class="muted small center">Egyfájlos verzió. Ha saját 44 kifejezésed van, szerkeszd a kód tetején a „DATA_FALLBACK” tömböt, vagy hagyd meg az eredeti INV/EXPRESSIONS tömböt – a program felismeri.</footer>
</div>

<script>
/* =====================
   1) DATA HANDLING
===================== */
const DATA_FALLBACK = [
      {id:'e1',  en:"I’m not sure what/where/why exactly.", hu:"nem tudom, pontosan mit/hol/miért …", cluster:"opinions"},
      {id:'e2',  en:"His main interest is …", hu:"fő érdeklődési köre …", cluster:"family"},
      {id:'e3',  en:"A lot of people get divorced and live on their own, and bring up their children on their own.", hu:"Sokan elválnak, egyedül élnek, és a gyerekeiket is egyedül nevelik.", cluster:"family"},
      {id:'e4',  en:"… which means …", hu:"ami azt jelenti, hogy …", cluster:"linkers"},
      {id:'e5',  en:"He … for a living.", hu:"vmit csinál a megélhetésért / él vmiből", cluster:"work"},
      {id:'e6',  en:"But I only have very vague memories of her.", hu:"De csak nagyon halvány emlékeim vannak róla.", cluster:"childhood"},
      {id:'e7',  en:"I come from quite a big family.", hu:"Elég nagy családból származom.", cluster:"family"},
      {id:'e8',  en:"However.", hu:"de / azonban", cluster:"linkers"},
      {id:'e9',  en:"I suppose.", hu:"azt hiszem / gondolom", cluster:"opinions"},
      {id:'e10', en:"As I remember …", hu:"amennyire emlékszem / ha jól emlékszem", cluster:"memory"},
      {id:'e11', en:"It was a lot better than …", hu:"sokkal jobb volt, mint …", cluster:"comparison"},
      {id:'e12', en:"Normally.", hu:"általában", cluster:"frequency"},
      {id:'e13', en:"By the way …", hu:"mellesleg", cluster:"linkers"},
      {id:'e14', en:"I have a lot of presents to buy at Christmas.", hu:"Sok ajándékot kell vennem karácsonykor.", cluster:"everyday"},
      {id:'e15', en:"They were around my age.", hu:"kb. velem egykorúak voltak.", cluster:"people"},
      {id:'e16', en:"They lived in the country for a while.", hu:"Vidéken éltek egy ideig.", cluster:"places"},
      {id:'e17', en:"Nowadays …", hu:"manapság", cluster:"time"},
      {id:'e18', en:"I don’t have a very close contact with …", hu:"nincs szoros kapcsolatom …-val/vel", cluster:"relationships"},
      {id:'e19', en:"He/She is the breadwinner in the family.", hu:"Ő a kenyérkereső a családban.", cluster:"family"},
      {id:'e20', en:"It sounds really nice.", hu:"Ez igazán jól hangzik.", cluster:"opinions"},
      {id:'e21', en:"I started to get my independence and lived my own life a bit.", hu:"Kezdtem önálló lenni, és a saját életemet élni.", cluster:"growing"},
      {id:'e22', en:"Occasionally.", hu:"néha", cluster:"frequency"},
      {id:'e23', en:"The family atmosphere is/was mostly very happy.", hu:"Nagyjából mindig jó volt a hangulat a családban.", cluster:"family"},
      {id:'e24', en:"During my early childhood …", hu:"kora gyermekkoromban", cluster:"childhood"},
      {id:'e25', en:"Things were never really the same after that.", hu:"Azután semmi sem volt már ugyanolyan.", cluster:"memory"},
      {id:'e26', en:"I must admit …", hu:"be kell vallanom / ismernem", cluster:"opinions"},
      {id:'e27', en:"In my growing years …", hu:"fiatalkoromban", cluster:"growing"},
      {id:'e28', en:"We didn’t get on so well a lot of times.", hu:"Sokszor nem jöttünk ki valami jól.", cluster:"relationships"},
      {id:'e29', en:"Every other week.", hu:"minden második héten", cluster:"time"},
      {id:'e30', en:"She seems to spend half of her life … (in the kitchen / cooking).", hu:"Fél életét (főzéssel) tölti.", cluster:"everyday"},
      {id:'e31', en:"… which was a bit disappointing for me.", hu:"ami elég kiábrándító volt", cluster:"feelings"},
      {id:'e32', en:"Actually …", hu:"öööö / hát / igazából", cluster:"fillers"},
      {id:'e33', en:"We have a lot of things in common / we have nothing in common.", hu:"Sok/semmi közös nincs bennünk.", cluster:"relationships"},
      {id:'e34', en:"He was not in the least interested in …", hu:"legkevésbé sem érdekelte …", cluster:"opinions"},
      {id:'e35', en:"As far as I know …", hu:"már amennyire én tudom …", cluster:"opinions"},
      {id:'e36', en:"He lived a very routine life.", hu:"Nagyon egyhangú életet élt.", cluster:"everyday"},
      {id:'e37', en:"I organised for him to go to Spain.", hu:"Elintéztem neki, hogy Spanyolországba utazzon.", cluster:"stories"},
      {id:'e38', en:"… which was really fascinating.", hu:"ami lenyűgöző volt", cluster:"feelings"},
      {id:'e39', en:"I suppose he is not just a sociable type.", hu:"Nem túl barátkozós típus.", cluster:"people"},
      {id:'e40', en:"I would say that …", hu:"azt mondanám, hogy …", cluster:"opinions"},
      {id:'e41', en:"He gets completely lost in his books.", hu:"Teljesen belemerül a könyveibe.", cluster:"people"},
      {id:'e42', en:"They really take care of each other.", hu:"Nagyon gondoskodnak egymásról.", cluster:"relationships"},
      {id:'e43', en:"One of my dreams is to be happily married to a ripe old age.", hu:"Álmom a boldog, hosszú házasság.", cluster:"dreams"},
      {id:'e44', en:"So they say.", hu:"Legalábbis ezt mondják.", cluster:"fillers"},
    ];


function normalizeData(raw){
  return raw.map((x, idx)=>{
    const hu=x.hu ?? x.HU ?? x.huText ?? x.hungarian ?? "";
    const en=x.en ?? x.EN ?? x.enText ?? x.english ?? "";
    const cluster=x.cluster ?? x.topic ?? "general";
    const id=String(x.id ?? idx+1);
    return {id, cluster, hu:String(hu).trim(), en:String(en).trim()};
  }).filter(x=>x.hu && x.en);
}

const RAW=(window.EXPRESSIONS || window.INV || window.CARDS || window.DATA || DATA_FALLBACK);
const DATA=normalizeData(RAW);
const CLUSTERS=Array.from(new Set(DATA.map(d=>d.cluster))).sort();

/* =====================
   2) STATE & STORAGE
===================== */
const LS={ get(k,def){try{const v=localStorage.getItem(k);return v?JSON.parse(v):(def??null);}catch(e){return def??null;}},
           set(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}, };
const SKEY={ known:(c)=>`expr_known_${c||'all'}`, stats:'expr_stats_v3' };
const STATS=LS.get(SKEY.stats,{ flashSeen:0, mc:{correct:0,total:0}, match:{correct:0,wrong:0}, qf:{best:0} });

/* =====================
   3) HELPERS
===================== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function sample(arr,n){ if(n>=arr.length) return shuffle(arr.slice()); const c=shuffle(arr.slice()); return c.slice(0,n); }
function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
const sideSel=()=>document.getElementById('side').value;
const clusterSel=()=>document.getElementById('cluster').value;
function byCluster(list){ const c=clusterSel(); return c==='all'? list.slice() : list.filter(x=>x.cluster===c); }
function getKnownSet(c){ return new Set(LS.get(SKEY.known(c), [])); }
function setKnownSet(c,set){ LS.set(SKEY.known(c), Array.from(set)); }
function addKnown(id){ const c=clusterSel(); const s=getKnownSet(c); s.add(id); setKnownSet(c,s); refreshKnownCount(); }
function refreshKnownCount(){ const c=clusterSel(); document.getElementById('known-count').textContent=getKnownSet(c).size; }
function saveStats(){ LS.set(SKEY.stats, STATS); }
function norm(s){ return String(s).trim().toLowerCase(); }

/* =====================
   4) INIT CONTROLS
===================== */
const clusterSelect=document.getElementById('cluster');
CLUSTERS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; clusterSelect.appendChild(o); });
document.getElementById('resetKnownCluster').addEventListener('click', ()=>{
  setKnownSet(clusterSel(), new Set());
  flashBuildDeck(); matchNewRound(); mcNext(); trNext(); spNext(); qfSetup(); renderProgress();
});

/* =====================
   5) TABS
===================== */
document.getElementById('tabs').addEventListener('click', (e)=>{
  const t=e.target.closest('.tab'); if(!t) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const id=t.dataset.tab;
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  if(id==='progress') renderProgress();
});

/* =====================
   6) FLASHCARDS
===================== */
let flashDeck=[], flashIdx=0, flashFlipped=false;
function flashBuildDeck(){
  const items=byCluster(DATA);
  const known=getKnownSet(clusterSel());
  flashDeck=shuffle(items.filter(x=>!known.has(x.id)));
  flashIdx=0; flashFlipped=false; renderFlash();
}
function renderFlash(){
  const front=document.getElementById('flash-front');
  const back=document.getElementById('flash-back');
  document.getElementById('flash-count').textContent=flashDeck.length;
  refreshKnownCount();
  if(!flashDeck.length){
    front.textContent='Ebben a klaszterben minden kártyát ismertnek jelöltél. (Használd a Reset gombot, ha újrakezdenéd.)';
    back.classList.add('hidden'); back.textContent=''; return;
  }
  const side=sideSel();
  const e=flashDeck[flashIdx % flashDeck.length];
  front.textContent = side==='hu-en'? e.hu : e.en;
  back.textContent  = side==='hu-en'? e.en : e.hu;
  back.classList.toggle('hidden', !flashFlipped);
}
function nextFlash(){ if(!flashDeck.length){renderFlash();return;} flashIdx=(flashIdx+1)%flashDeck.length; flashFlipped=false; STATS.flashSeen++; saveStats(); renderFlash(); }
function flashKnow(){ if(!flashDeck.length) return; addKnown(flashDeck[flashIdx].id); flashDeck.splice(flashIdx,1); if(flashIdx>=flashDeck.length) flashIdx=0; flashFlipped=false; renderFlash(); }
document.getElementById('flash-flip').addEventListener('click', ()=>{ flashFlipped=!flashFlipped; renderFlash(); });
document.getElementById('flash-know').addEventListener('click', flashKnow);
document.getElementById('flash-keep').addEventListener('click', nextFlash);
document.getElementById('flash-next').addEventListener('click', nextFlash);
document.getElementById('side').addEventListener('change', ()=>{ renderFlash(); mcNext(); trNext(); spNext(); qfSetup(); });
document.getElementById('cluster').addEventListener('change', ()=>{ flashBuildDeck(); matchNewRound(); mcNext(); trNext(); spNext(); qfSetup(); renderProgress(); });
window.addEventListener('keydown', (e)=>{
  if(document.querySelector('.panel.active')?.id!=='panel-flash') return;
  if(e.key.toLowerCase()==='f') document.getElementById('flash-flip').click();
  if(e.key.toLowerCase()==='k') document.getElementById('flash-know').click();
  if(e.key.toLowerCase()==='r') document.getElementById('flash-next').click();
});

/* =====================
   7) MATCHING
===================== */
let matchLeftSel=null, matchRightSel=null, matchPairs=[];
function matchNewRound(){
  const items=byCluster(DATA);
  const round=sample(items, Math.min(6, items.length));
  matchPairs=round.map(x=>({id:x.id,left:(sideSel()==='hu-en'?x.hu:x.en),right:(sideSel()==='hu-en'?x.en:x.hu)}));
  const left=document.getElementById('match-left'); const right=document.getElementById('match-right'); left.innerHTML=''; right.innerHTML='';
  shuffle(matchPairs);
  const L=matchPairs.slice(); const R=shuffle(matchPairs.slice());
  L.forEach(p=>{ const el=document.createElement('div'); el.className='item'; el.textContent=p.left; el.dataset.id=p.id; el.addEventListener('click',()=>matchSelect('L',el)); left.appendChild(el); });
  R.forEach(p=>{ const el=document.createElement('div'); el.className='item'; el.textContent=p.right; el.dataset.id=p.id; el.addEventListener('click',()=>matchSelect('R',el)); right.appendChild(el); });
  matchLeftSel=null; matchRightSel=null;
}
function matchSelect(side, el){
  if(el.classList.contains('correct')) return;
  if(side==='L'){ if(matchLeftSel){matchLeftSel.classList.remove('selected');} matchLeftSel=el; el.classList.add('selected'); }
  else { if(matchRightSel){matchRightSel.classList.remove('selected');} matchRightSel=el; el.classList.add('selected'); }
  if(matchLeftSel && matchRightSel){
    if(matchLeftSel.dataset.id===matchRightSel.dataset.id){ matchLeftSel.classList.remove('selected'); matchRightSel.classList.remove('selected'); matchLeftSel.classList.add('correct'); matchRightSel.classList.add('correct'); STATS.match.correct++; saveStats(); document.getElementById('match-correct').textContent=STATS.match.correct; }
    else{ matchLeftSel.classList.add('wrong'); matchRightSel.classList.add('wrong'); setTimeout(()=>{ matchLeftSel.classList.remove('selected','wrong'); matchRightSel.classList.remove('selected','wrong'); matchLeftSel=null; matchRightSel=null; },400); STATS.match.wrong++; saveStats(); document.getElementById('match-wrong').textContent=STATS.match.wrong; }
  }
}
document.getElementById('match-reset').addEventListener('click', matchNewRound);
document.getElementById('match-next').addEventListener('click', matchNewRound);

/* =====================
   8) MULTIPLE CHOICE
===================== */
let MC=null;
function mcBuild(){ const pool=byCluster(DATA); const q=pick(pool); const side=sideSel(); const prompt=(side==='hu-en')? q.hu:q.en; const correct=(side==='hu-en')? q.en:q.hu; const distract=shuffle(pool.filter(x=>x.id!==q.id)).slice(0,3).map(x=>(side==='hu-en')?x.en:x.hu); const options=shuffle([correct,...distract]); return {q,prompt,correct,options}; }
function mcRender(){ if(!MC){MC=mcBuild();} document.getElementById('mc-prompt').textContent=MC.prompt; const wrap=document.getElementById('mc-answers'); wrap.innerHTML=''; MC.options.forEach(opt=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=opt; b.addEventListener('click',()=>{ STATS.mc.total++; if(norm(opt)===norm(MC.correct)){ b.classList.remove('ghost'); b.classList.add('ok'); STATS.mc.correct++; } else { b.classList.remove('ghost'); b.classList.add('bad'); } saveStats(); document.getElementById('mc-correct').textContent=STATS.mc.correct; document.getElementById('mc-total').textContent=STATS.mc.total; }); wrap.appendChild(b); }); document.getElementById('mc-correct').textContent=STATS.mc.correct; document.getElementById('mc-total').textContent=STATS.mc.total; }
function mcNext(){ MC=mcBuild(); mcRender(); }
document.getElementById('mc-next').addEventListener('click', mcNext);

/* =====================
   9) TRANSFORMATION
===================== */
let TR=null;
function trBuild(){ const pool=byCluster(DATA); const e=pick(pool); const side=sideSel(); const prompt=(side==='hu-en')? e.hu:e.en; const answer=(side==='hu-en')? e.en:e.hu; return {e,prompt,answer}; }
function trNext(){ TR=trBuild(); trRender(); }
function trRender(){ document.getElementById('tr-prompt').textContent=TR.prompt; document.getElementById('tr-input').value=''; document.getElementById('tr-feedback').textContent=''; }
document.getElementById('tr-check').addEventListener('click',()=>{ const v=document.getElementById('tr-input').value; const ok=norm(v)===norm(TR.answer); const fb=document.getElementById('tr-feedback'); if(ok){ fb.textContent="Helyes! "+TR.answer; fb.style.color='#86efac'; } else { fb.innerHTML="Még nem jó. Helyes: <b>"+TR.answer+"</b>"; fb.style.color='#fca5a5'; } });
document.getElementById('tr-next').addEventListener('click', trNext);
document.getElementById('tr-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') document.getElementById('tr-check').click(); });

/* =====================
  10) PROMPTED SPEAKING – task + 60s timer + strike-through chips
===================== */
const SPEAK_TEMPLATES={
  family:["Introduce your best friend and say why you get along.","Give advice to a friend about handling family rules.","Describe a time when there was no drama at home.","Explain what your main interest is and why."],
  opinions:["Share your opinion about a popular reality show.","Agree or disagree with this: 'School uniforms are useful.' Explain.","Say what you think about social media for teens.","Politely disagree with a classmate's idea."],
  daily:["Describe your weekday routine in two or three sentences.","Explain how you try to spend more time outdoors.","Tell a classmate how you manage your time on school days."],
  school:["Give tips to a younger student about preparing for an exam.","Explain one school rule and say if you agree with it.","Talk about how you will learn a new skill this term."],
  general:["Answer a simple 'Tell me about yourself' question.","Give advice to a friend who feels overwhelmed."]
};
let SP={exprs:[], used:[false,false,false], t:60, timer:null};
function spRenderExprs(){
  const wrap=document.getElementById('sp-exprs'); wrap.innerHTML='Use these 3 expressions: ';
  SP.exprs.forEach((text, i)=>{
    const chip=document.createElement('span'); chip.className='chip'; chip.textContent=text; chip.dataset.idx=i;
    if(SP.used[i]) chip.classList.add('used');
    chip.addEventListener('click', ()=> spToggleUsed(i, chip));
    wrap.appendChild(chip);
  });
}
function spToggleUsed(i, chipEl){
  SP.used[i]=!SP.used[i];
  chipEl.classList.toggle('used', SP.used[i]);
}
function spResetTimer(){
  if(SP.timer){ clearInterval(SP.timer); SP.timer=null; }
  SP.t=60; document.getElementById('sp-timer').textContent=SP.t;
}
function spStartTimer(){
  spResetTimer();
  SP.timer=setInterval(()=>{
    SP.t--; document.getElementById('sp-timer').textContent=SP.t;
    if(SP.t<=0){ clearInterval(SP.timer); SP.timer=null; }
  },1000);
}
function spStopTimer(){ if(SP.timer){ clearInterval(SP.timer); SP.timer=null; } }
function spNext(){
  spStopTimer(); spResetTimer();
  const c=clusterSel(); const pool=byCluster(DATA);
  SP.exprs = sample(pool, Math.min(3, pool.length)).map(x=>x.en);
  SP.used=[false,false,false];
  const taskPool=SPEAK_TEMPLATES[c] || SPEAK_TEMPLATES.general;
  document.getElementById('sp-prompt').textContent="Task: "+pick(taskPool);
  spRenderExprs();
}
document.getElementById('sp-start').addEventListener('click', spStartTimer);
document.getElementById('sp-stop').addEventListener('click', spStopTimer);
document.getElementById('sp-next').addEventListener('click', spNext);
document.getElementById('sp-done').addEventListener('click', ()=>{ STATS.flashSeen++; saveStats(); spStopTimer(); spNext(); });
// Keyboard: 1-3 toggles chips when speaking panel active
window.addEventListener('keydown', (e)=>{
  if(document.querySelector('.panel.active')?.id!=='panel-speaking') return;
  if(['1','2','3'].includes(e.key)){ const idx=Number(e.key)-1; const chips=[...document.querySelectorAll('#sp-exprs .chip')]; if(chips[idx]) chips[idx].click(); }
});

/* =====================
   11) QUICK FIRE / BINGO
===================== */
let QF={running:false, t:60, timer:null, score:0, hits:0, prompt:null, tiles:[]};
function qfBuildTiles(){
  const pool=byCluster(DATA);
  const twelve=sample(pool, Math.min(12, pool.length));
  return twelve.map(x=>({
    id:x.id,
    prompt:(sideSel()==='hu-en')? x.hu : x.en,
    shown:(sideSel()==='hu-en')? x.en : x.hu,
    done:false
  }));
}
function qfRenderGrid(){
  const grid=document.getElementById('qf-grid'); grid.innerHTML='';
  QF.tiles.forEach(t=>{
    const el=document.createElement('div'); el.className='tile'; el.textContent=t.shown; el.dataset.id=t.id;
    if(t.done) el.classList.add('hit');
    el.addEventListener('click', ()=> qfClick(el));
    grid.appendChild(el);
  });
}
function qfSetup(){
  QF.running=false; QF.t=60; QF.score=0; QF.hits=0; QF.prompt=null;
  if(QF.timer){ clearInterval(QF.timer); QF.timer=null; }
  QF.tiles=qfBuildTiles();
  document.getElementById('qf-score').textContent='0';
  document.getElementById('qf-hits').textContent='0';
  document.getElementById('qf-timer').textContent='60';
  document.getElementById('qf-prompt').textContent='Kezdéshez kattints a Start gombra.';
  qfRenderGrid();
}
function qfRefillTilesDuringRun(){ QF.tiles=qfBuildTiles(); qfRenderGrid(); }
function qfStart(){
  if(QF.timer){ clearInterval(QF.timer); QF.timer=null; }
  if(!QF.tiles || QF.tiles.length===0){ QF.tiles=qfBuildTiles(); qfRenderGrid(); }
  QF.running=true; QF.t=60; QF.score=0; QF.hits=0;
  document.getElementById('qf-score').textContent='0';
  document.getElementById('qf-hits').textContent='0';
  document.getElementById('qf-timer').textContent=QF.t;
  qfNextPrompt();
  QF.timer=setInterval(()=>{
    QF.t--; document.getElementById('qf-timer').textContent=QF.t;
    if(QF.t<=0){
      clearInterval(QF.timer); QF.timer=null; QF.running=false;
      document.getElementById('qf-prompt').textContent='Vége! Pont: '+QF.score+'  |  Találat: '+QF.hits+'/12';
      if(QF.score>STATS.qf.best){ STATS.qf.best=QF.score; saveStats(); }
      renderProgress();
    }
  },1000);
}
function qfNextPrompt(){
  const remaining=QF.tiles.filter(t=>!t.done);
  if(remaining.length===0){ qfRefillTilesDuringRun(); }
  const cand=QF.tiles.filter(t=>!t.done);
  const target=cand.length? pick(cand) : pick(QF.tiles);
  QF.prompt=target;
  document.getElementById('qf-prompt').textContent=target.prompt;
}
function qfClick(el){
  if(!QF.running) return;
  const id=el.dataset.id;
  if(QF.prompt && QF.prompt.id===id){
    el.classList.add('hit'); el.classList.remove('miss');
    const tile=QF.tiles.find(t=>t.id===id); if(tile) tile.done=true;
    QF.score+=10; QF.hits++;
    document.getElementById('qf-score').textContent=QF.score;
    document.getElementById('qf-hits').textContent=QF.hits;
    qfNextPrompt();
  }else{
    el.classList.add('miss'); setTimeout(()=>el.classList.remove('miss'),200);
    QF.score=Math.max(0, QF.score-2);
    document.getElementById('qf-score').textContent=QF.score;
  }
}
document.getElementById('qf-start').addEventListener('click', qfStart);

/* =====================
   12) PROGRESS
===================== */
function renderProgress(){
  let knownTotal=0; CLUSTERS.forEach(c=> knownTotal+=getKnownSet(c).size );
  document.getElementById('pg-known').textContent=knownTotal;
  document.getElementById('pg-flash').textContent=STATS.flashSeen;
  document.getElementById('pg-match').textContent=STATS.match.correct+' / '+STATS.match.wrong;
  document.getElementById('pg-mc').textContent=STATS.mc.correct+' / '+STATS.mc.total;
  document.getElementById('pg-qf').textContent=STATS.qf.best;
  const box=document.getElementById('pg-clusters'); box.innerHTML='<div class="muted" style="margin-bottom:8px">Klaszterenkénti ismert kártyák</div>';
  const grid=document.createElement('div'); grid.className='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(160px,1fr))';
  CLUSTERS.forEach(c=>{ const k=getKnownSet(c).size; const total=DATA.filter(x=>x.cluster===c).length; const el=document.createElement('div'); el.className='card'; el.innerHTML='<div><div class="muted small">'+c+'</div><div style="font-size:20px" class="mono">'+k+' / '+total+'</div></div>'; grid.appendChild(el); });
  box.appendChild(grid);
}

/* =====================
   13) INIT
===================== */
function init(){ flashBuildDeck(); matchNewRound(); mcNext(); trNext(); spNext(); qfSetup(); renderProgress(); }
init();
</script>
</body>
</html>
