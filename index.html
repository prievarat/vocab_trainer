<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Expressions Trainer (HU ⇄ EN) — v4</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --muted:#9aa4b2; --fg:#e5eef7;
    --primary:#2563eb; --ok:#16a34a; --bad:#ef4444; --pill:#1f2937; --accent:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  h1{font-weight:800;margin:0 0 12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,.btn{background:#0d1b2a;border:1px solid #1e293b;color:var(--fg);padding:8px 12px;border-radius:8px}
  .btn.primary{background:var(--primary);border-color:transparent}
  .btn.ok{background:#14532d}
  .pill{background:#1e293b;padding:6px 10px;border-radius:999px;font-size:14px;color:var(--muted)}
  nav.tabs{display:flex;gap:10px;margin:8px 0 14px}
  .tab{padding:10px 14px;border-radius:10px;background:#0d1b2a;border:1px solid #1e293b;cursor:pointer;user-select:none}
  .tab.active{background:#12243a;border-color:#34526e}
  .panel{display:none;background:var(--panel);border:1px solid #1e293b;border-radius:12px;padding:16px}
  .panel.active{display:block}
  .between{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .card{padding:10px 12px;border-radius:10px;background:#0d1b2a;border:1px solid #1f2a3a;cursor:pointer;text-align:left}
  .card.active{outline:2px solid var(--accent)}
  .card.ok{background:#0e3720;border-color:#1f6a35}
  .card.bad{background:#3a0e0e;border-color:#7a1f1f}
  #flash-front,#flash-back{min-height:90px;display:flex;align-items:center;justify-content:center;font-size:20px;gap:8px}
  .tile{padding:12px;border-radius:10px;background:#0d1b2a;border:1px solid #1f2a3a;text-align:center;cursor:pointer}
  .tile.hit{background:#0e3720;border-color:#1f6a35}
  .tile.miss{background:#3a0e0e;border-color:#7a1f1f}
  .timer{font-weight:800;font-size:22px}
  .err{background:#3f1d1d;color:#ffd7d7;padding:8px;border:1px solid #a33;border-radius:8px;margin:10px 0;display:none}


/* === Unified styling for Matching + Multiple Choice (hardwired look) === */
#panel-matching, #panel-mc{
  background: var(--panel) !important;
  border:1px solid #1e293b;
  border-radius:14px;
}

/* General grid spacing inside panels */
#panel-matching .grid, #panel-mc .grid{ gap:10px; }

/* Headline / question text */
#panel-mc #mc-q, #panel-matching .muted{
  color: var(--fg);
}

/* Cards / options look the same in both panels */
#panel-matching .card, #panel-mc button.card{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  color: var(--fg) !important;
  background:#0d1b2a !important;
  border:1px solid #1f2a3a !important;
  border-radius:14px !important;
  padding:14px 16px !important;
  font-size:18px !important;
  line-height:1.3 !important;
  cursor:pointer;
  text-align:center;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset, 0 8px 16px rgba(0,0,0,0.35);
}

/* Active / feedback states */
#panel-matching .card.active, #panel-mc .card.active{ outline:2px solid var(--accent) !important; }
#panel-matching .card.ok,     #panel-mc .card.ok{ background:#0e3720 !important; border-color:#1f6a35 !important; }
#panel-matching .card.bad,    #panel-mc .card.bad{ background:#3a0e0e !important; border-color:#7a1f1f !important; }

/* Pills / little status chips */
#panel-matching .pill, #panel-mc .pill{
  background:#111827; border:1px solid var(--border); border-radius:14px;
  padding:4px 10px; font-size:12px; color:var(--muted);
}
</style>
</head>
<body>
<div class="wrap">
<div class="err" id="err"></div>
<h1>Expressions Trainer (HU ⇄ EN) — v4</h1>
<div class="row">
<div>Oldal:</div>
<select id="side">
<option value="hu-en">HU → EN</option>
<option value="en-hu">EN → HU</option>
</select>
<div>Klaszter:</div>
<select class="select" id="cluster"></select>
<button class="btn" id="reset">Reset known for this cluster</button>
<span class="pill">Billentyűk: F=Flip, K=I know, R=Next</span>
</div>
<nav class="tabs" id="tabs">
<div class="tab active" data-tab="flash">Flashcards</div>
<div class="tab" data-tab="matching">Matching</div>
<div class="tab" data-tab="mc">Multiple Choice</div>
<div class="tab" data-tab="quick">Quick Fire / Bingo</div>
</nav>
<!-- Flashcards -->
<section class="panel active" id="panel-flash">
<div class="between">
<div class="muted">Aktív pakli: <span id="flash-count">0</span> kártya</div>
<div class="muted">Ismert kártyák a klaszterben: <span id="known-count">0</span></div>
</div>
<div id="flash-front" style="margin-top:10px">—</div>
<div class="muted" id="flash-back"> </div>
<div class="row" style="margin-top:12px">
<button class="btn" id="flash-flip">Flip (F)</button>
<button class="btn ok" id="flash-know">I know (K)</button>
<button class="btn" id="flash-still">Still studying</button>
<button class="btn" id="flash-next">Next (R)</button>
</div>
</section>
<!-- Matching -->
<section class="panel" id="panel-matching">
<div class="grid">
<div>
<div class="muted">Hungarian</div>
<div class="grid" id="match-left"></div>
</div>
<div>
<div class="muted">English</div>
<div class="grid" id="match-right"></div>
</div>
</div>
<div class="row" style="margin-top:8px">
<button class="btn" id="match-new">New round</button>
<span class="pill">Score: <span id="match-score">0</span></span>
</div>
</section>
<!-- Multiple Choice -->
<section class="panel" id="panel-mc">
<div class="muted" id="mc-q">—</div>
<div class="grid" id="mc-opts" style="margin-top:10px"></div>
<div class="row" style="margin-top:8px">
<button class="btn" id="mc-next">Next</button>
<span class="pill">Score: <span id="mc-score">0</span></span>
</div>
</section>
<!-- Quick Fire / Bingo -->
<section class="panel" id="panel-quick">
<div class="between">
<div class="row">
<button class="btn primary" id="qf-start">Start (60s)</button>
<span class="pill">Pont: <span id="qf-score">0</span></span>
<span class="pill">Találat: <span id="qf-hits">0</span>/12</span>
</div>
<div class="timer" id="qf-timer">60</div>
</div>
<div class="muted" id="qf-prompt" style="margin-top:10px">Kezdéshez kattints a Start gombra.</div>
<div class="grid" id="qf-grid" style="margin-top:10px"></div>
</section>
</div>
<script>
/* =====================
   1) DATA
===================== */
const DATA_FALLBACK = [
  { en:'I’m not sure what/where/why exactly.', hu:'nem tudom, pontosan mit/hol/miért …', cluster:'family' },
  { en:'His main interest is …', hu:'fő érdeklődési köre …', cluster:'family' },
  { en:'A lot of people get divorced and live on their own, and bring up their children on their own.', hu:'Sokan elválnak, egyedül élnek, és a gyerekeiket is egyedül nevelik.', cluster:'family' },
  { en:'… which means …', hu:'ami azt jelenti, hogy …', cluster:'family' },
  { en:'He … for a living.', hu:'vmit csinál a megélhetésért / él vmiből', cluster:'family' },
  { en:'But I only have very vague memories of her.', hu:'De csak nagyon halvány emlékeim vannak róla.', cluster:'family' },
  { en:'I come from quite a big family.', hu:'Elég nagy családból származom.', cluster:'family' },
  { en:'However.', hu:'de / azonban', cluster:'family' },
  { en:'I suppose.', hu:'azt hiszem / gondolom', cluster:'family' },
  { en:'As I remember …', hu:'amennyire emlékszem / ha jól emlékszem', cluster:'family' },
  { en:'It was a lot better than …', hu:'sokkal jobb volt, mint …', cluster:'family' },
  { en:'Normally.', hu:'általában', cluster:'family' },
  { en:'By the way …', hu:'mellesleg', cluster:'family' },
  { en:'I have a lot of presents to buy at Christmas.', hu:'Sok ajándékot kell vennem karácsonykor.', cluster:'family' },
  { en:'They were around my age.', hu:'kb. velem egykorúak voltak.', cluster:'family' },
  { en:'They lived in the country for a while.', hu:'Vidéken éltek egy ideig.', cluster:'family' },
  { en:'Nowadays …', hu:'manapság', cluster:'family' },
  { en:'I don’t have a very close contact with …', hu:'nincs szoros kapcsolatom …-val/vel', cluster:'family' },
  { en:'He/She is the breadwinner in the family.', hu:'Ő a kenyérkereső a családban.', cluster:'family' },
  { en:'It sounds really nice.', hu:'Ez igazán jól hangzik.', cluster:'family' },
  { en:'I started to get my independence and lived my own life a bit.', hu:'Kezdtem önálló lenni, és a saját életemet élni.', cluster:'family' },
  { en:'Occasionally.', hu:'néha', cluster:'family' },
  { en:'The family atmosphere is/was mostly very happy.', hu:'Nagyjából mindig jó volt a hangulat a családban.', cluster:'family' },
  { en:'During my early childhood …', hu:'kora gyermekkoromban', cluster:'family' },
  { en:'Things were never really the same after that.', hu:'Azután semmi sem volt már ugyanolyan.', cluster:'family' },
  { en:'I must admit …', hu:'be kell vallanom / ismernem', cluster:'family' },
  { en:'In my growing years …', hu:'fiatalkoromban', cluster:'family' },
  { en:'We didn’t get on so well a lot of times.', hu:'Sokszor nem jöttünk ki valami jól.', cluster:'family' },
  { en:'Every other week.', hu:'minden második héten', cluster:'family' },
  { en:'She seems to spend half of her life … (in the kitchen / cooking).', hu:'Fél életét (főzéssel) tölti.', cluster:'family' },
  { en:'… which was a bit disappointing for me.', hu:'ami elég kiábrándító volt', cluster:'family' },
  { en:'Actually …', hu:'öööö / hát / igazából', cluster:'family' },
  { en:'We have a lot of things in common / we have nothing in common.', hu:'Sok/semmi közös nincs bennünk.', cluster:'family' },
  { en:'He was not in the least interested in …', hu:'legkevésbé sem érdekelte …', cluster:'family' },
  { en:'As far as I know …', hu:'már amennyire én tudom …', cluster:'family' },
  { en:'He lived a very routine life.', hu:'Nagyon egyhangú életet élt.', cluster:'family' },
  { en:'I organised for him to go to Spain.', hu:'Elintéztem neki, hogy Spanyolországba utazzon.', cluster:'family' },
  { en:'… which was really fascinating.', hu:'ami lenyűgöző volt', cluster:'family' },
  { en:'I suppose he is not just a sociable type.', hu:'Nem túl barátkozós típus.', cluster:'family' },
  { en:'I would say that …', hu:'azt mondanám, hogy …', cluster:'family' },
  { en:'He gets completely lost in his books.', hu:'Teljesen belemerül a könyveibe.', cluster:'family' },
  { en:'They really take care of each other.', hu:'Nagyon gondoskodnak egymásról.', cluster:'family' },
  { en:'One of my dreams is to be happily married to a ripe old age.', hu:'Álmom a boldog, hosszú házasság.', cluster:'family' },
  { en:'So they say.', hu:'Legalábbis ezt mondják.', cluster:'family' },
  { en:'My daily routine is a bit different now that I’m working/studying…', hu:'Egy kicsit más a napjaim beosztása most, hogy tanulok/dolgozom…', cluster:'daily' },
  { en:'I get a cake or something on the way.', hu:'Veszek egy sütit, vagy valami mást útközben.', cluster:'daily' },
  { en:'All the time.', hu:'Állandóan.', cluster:'daily' },
  { en:'There are certain tasks I have to do…', hu:'Vannak bizonyos feladatok, amiket el kell végeznem…', cluster:'daily' },
  { en:'It is quite nice because it means…', hu:'Ez elég jó, mert ez azt jelenti, hogy…', cluster:'daily' },
  { en:'I have some homework to do.', hu:'Van házim, amit meg kell csinálnom.', cluster:'daily' },
  { en:'Afterwards.', hu:'Azután.', cluster:'daily' },
  { en:'I have an excuse to do something.', hu:'Van mentségem arra, hogy…', cluster:'daily' },
  { en:'I tend to (do something).', hu:'Hajlamos vagyok arra, hogy…', cluster:'daily' },
  { en:'I find it quite difficult (to do something).', hu:'Elég nehéznek találom, hogy…', cluster:'daily' },
  { en:'It’s (not) something I particularly enjoy.', hu:'Ez egy olyan valami, amit (nem) különösen élvezek.', cluster:'daily' },
  { en:'I stay quite late at work/school.', hu:'Sokáig dolgozom / sokáig vagyok iskolában.', cluster:'daily' },
  { en:'I do some shopping on the way back home.', hu:'Bevásárolok hazafelé.', cluster:'daily' },
  { en:'I don’t read as many books as I should / used to.', hu:'Nem olvasok annyit, amennyit kellene / amennyit régen szoktam.', cluster:'daily' },
  { en:'I like to find time in the day for things that are really important to me.', hu:'Szeretek időt találni a nap során azokra a dolgokra, amelyek igazán fontosak a számomra.', cluster:'daily' },
  { en:'Learning to play the piano, etc. is very demanding.', hu:'Zongorázni megtanulni stb. nagyon megterhelő.', cluster:'daily' },
  { en:'Some things have to be done at a certain time.', hu:'Bizonyos dolgokat időre meg kell csinálni.', cluster:'daily' },
  { en:'I give these things priority (over other things).', hu:'Ezek a dolgok prioritást élveznek (más dolgokkal szemben).', cluster:'daily' },
  { en:'I don’t have special times for these things.', hu:'Nincs külön idő félretéve ezeknek a dolgoknak.', cluster:'daily' },
  { en:'I have to get up very early to go to lessons.', hu:'Nagyon korán kell kelnem, mert óráim vannak / iskolába járok.', cluster:'daily' },
  { en:'I have a lot of family commitments.', hu:'Sok családi kötelezettségem van.', cluster:'daily' },
  { en:'One thing is regular in my life, and that is…', hu:'Egy dolog rendszeres az életemben, ez pedig…', cluster:'daily' },
  { en:'For some reason…', hu:'Valamilyen okból kifolyólag…', cluster:'daily' },
  { en:'I find this both challenging and satisfying.', hu:'Ez nagy kihívást és nagy elégedettséget jelent számomra.', cluster:'daily' },
  { en:'I feel I’ve achieved something.', hu:'Úgy érzem, hogy elértem valamit.', cluster:'daily' },
  { en:'I spend a lot of time learning…', hu:'Sok időt töltök tanulással…', cluster:'daily' },
  { en:'I sometimes have free periods with no lessons.', hu:'Néha lyukasóráim vannak.', cluster:'daily' },
  { en:'From this time onwards…', hu:'Innentől kezdve…', cluster:'daily' },
  { en:'I suppose a bit of balance in everything is really important.', hu:'Úgy gondolom, hogy az egyensúly mindenben rendkívül fontos.', cluster:'daily' },
  { en:'Sometimes I oversleep and miss the bus in the morning.', hu:'Néha elalszom, és lekésem a buszt reggel.', cluster:'daily' } 
];
function normalizeData(raw){
  return raw.map((x,idx)=>({ 
    id:String(x.id ?? idx+1),
    cluster:(x.cluster ?? x.topic ?? 'general').toLowerCase(),
    hu:String(x.hu ?? '').trim(),
    en:String(x.en ?? '').trim()
  })).filter(x=>x.hu && x.en);
}
const RAW = DATA_FALLBACK;
const DATA = normalizeData(RAW);
const CLUSTERS = ['family','daily'];

/* =====================
   2) HELPERS & STATE
===================== */
function $(id){return document.getElementById(id)}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function sample(arr,n){if(n>=arr.length) return shuffle(arr.slice()); const c=shuffle(arr.slice()); return c.slice(0,n);}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function sideSel(){return $('side').value}
function clusterSel(){return $('cluster').value}
function byCluster(list){const c=clusterSel(); return c==='all'? list.slice() : list.filter(x=>x.cluster===c)}
function lsKey(c){return 'known-'+c}
function getKnownSet(c){
  if(c==='all'){ const s=new Set(); CLUSTERS.forEach(k=>{ try{(JSON.parse(localStorage.getItem(lsKey(k)))||[]).forEach(x=>s.add(x))}catch(_ ){} }); return s; }
  try{return new Set(JSON.parse(localStorage.getItem(lsKey(c)))||[])}
  catch(_ ){return new Set();}
}
function setKnownSet(c,set){ 
  if(c==='all'){ CLUSTERS.forEach(k=>localStorage.removeItem(lsKey(k))); return; }
  localStorage.setItem(lsKey(c), JSON.stringify(Array.from(set)));
}
function refreshKnownCount(){ const c=clusterSel(); $('known-count').textContent = getKnownSet(c).size; }

/* =====================
   3) CLUSTER SELECT
===================== */
function buildClusterSelect(){ 
  const sel=$('cluster'); sel.innerHTML='';
  const optAll=document.createElement('option'); optAll.value='all'; optAll.textContent='All'; sel.appendChild(optAll);
  const labels={family:'Family', daily:'Daily routine'};
  CLUSTERS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=labels[c]||c; sel.appendChild(o); });
  sel.value='family';
}

/* =====================
   4) FLASHCARDS
===================== */
let flashDeck=[], flashIdx=0, flashFlipped=false;
function flashBuildDeck(){ 
  const items=byCluster(DATA);
  const knownAll=getKnownSet('all');
  flashDeck = shuffle(items.filter(x=>!knownAll.has(x.id)));
  flashIdx=0; flashFlipped=false; renderFlash();
}
function renderFlash(){ 
  const front=$('flash-front'), back=$('flash-back');
  $('flash-count').textContent = flashDeck.length;
  refreshKnownCount();
  if(!flashDeck.length){ front.textContent='Nincs több kártya ebben a témában.'; back.textContent=''; return; }
  const card=flashDeck[flashIdx];
  const showFront = sideSel()==='hu-en'? card.hu : card.en;
  const showBack  = sideSel()==='hu-en'? card.en : card.hu;
  front.textContent = flashFlipped? showBack : showFront;
  back.textContent  = flashFlipped? '' : showBack;
}
function flashFlip(){ flashFlipped=!flashFlipped; renderFlash(); }
function flashKnow(){ 
  if(!flashDeck.length) return;
  const c = flashDeck[flashIdx];
  const set = getKnownSet(c.cluster); set.add(c.id); setKnownSet(c.cluster, set);
  flashDeck.splice(flashIdx,1);
  if(flashIdx>=flashDeck.length) flashIdx=0;
  renderFlash();
}
function flashStill(){ if(!flashDeck.length) return; flashIdx = (flashIdx+1)%flashDeck.length; flashFlipped=false; renderFlash(); }
function flashNext(){  if(!flashDeck.length) return; flashIdx = (flashIdx+1)%flashDeck.length; flashFlipped=false; renderFlash(); }

/* =====================
   5) MATCHING (bugfixed)
===================== */
let matchScore=0, matchFirst=null, matchLocked=false;
function matchNewRound(){ 
  const pool=byCluster(DATA);
  matchFirst=null; matchLocked=false;
  const take=Math.min(6, pool.length);
  const pairs = sample(pool, take).map(it=>({id:it.id,left:it.hu,right:it.en}));
  const left = shuffle(pairs.map(p=>({id:p.id,text:p.left})));
  const right= shuffle(pairs.map(p=>({id:p.id,text:p.right})));
  const colL=$('match-left'), colR=$('match-right'); colL.innerHTML=''; colR.innerHTML='';
  left.forEach(item=>{ const b=document.createElement('button'); b.className='card'; b.dataset.id=item.id; b.textContent=item.text; b.onclick=()=>matchSelect('L',item.id,b); colL.appendChild(b); });
  right.forEach(item=>{ const b=document.createElement('button'); b.className='card'; b.dataset.id=item.id; b.textContent=item.text; b.onclick=()=>matchSelect('R',item.id,b); colR.appendChild(b); });
  $('match-score').textContent=String(matchScore);
}
function matchSelect(side,id,el){ 
  if(matchLocked||el.disabled) return;
  if(!matchFirst){ matchFirst={side,id,el}; el.classList.add('active'); return; }
  if(matchFirst.el===el){ el.classList.remove('active'); matchFirst=null; return; }
  if(matchFirst.side===side){ matchFirst.el.classList.remove('active'); matchFirst={side,id,el}; el.classList.add('active'); return; }
  matchLocked=true; const first=matchFirst; matchFirst=null;
  const ok = (first.id===id);
  if(ok){ [first.el,el].forEach(b=>{b.classList.add('ok'); b.disabled=true;}); matchScore+=10; }
  else { [first.el,el].forEach(b=>b.classList.add('bad')); setTimeout(()=>{[first.el,el].forEach(b=>{b.classList.remove('bad'); b.classList.remove('active');});},250); matchScore=Math.max(0,matchScore-2); }
  $('match-score').textContent=String(matchScore);
  matchLocked=false;
}

/* =====================
   6) MULTIPLE CHOICE
===================== */
let mcScore=0;
function mcNext(){ 
  const pool=byCluster(DATA);
  if(pool.length<2){ $('mc-q').textContent='Not enough cards.'; $('mc-opts').innerHTML=''; return; }
  const correct=pick(pool);
  const distractors=sample(pool.filter(x=>x.id!==correct.id), Math.min(3, pool.length-1));
  const options=shuffle([correct, ...distractors]);
  $('mc-q').textContent = sideSel()==='hu-en'? correct.hu : correct.en;
  const opts=$('mc-opts'); opts.innerHTML='';
  options.forEach(o=>{ const btn=document.createElement('button'); btn.className='card'; btn.textContent= sideSel()==='hu-en'? o.en : o.hu;
    btn.onclick=()=>{ if(o.id===correct.id){ mcScore+=10; btn.classList.add('ok'); } else { mcScore=Math.max(0,mcScore-2); btn.classList.add('bad'); } $('mc-score').textContent=String(mcScore); setTimeout(mcNext,250); };
    opts.appendChild(btn);
  });
}

/* =====================
   7) QUICK FIRE / BINGO
===================== */
let QF={running:false,t:60,timer:null,score:0,hits:0,prompt:null,tiles:[]};
function qfBuildTiles(){ 
  const pool=byCluster(DATA);
  const twelve=sample(pool, Math.min(12, pool.length));
  return twelve.map(x=>({id:x.id, prompt: sideSel()==='hu-en'? x.hu : x.en, shown: sideSel()==='hu-en'? x.en : x.hu, done:false}));
}
function qfRenderGrid(){ 
  const grid=$('qf-grid'); grid.innerHTML='';
  QF.tiles.forEach(t=>{ const el=document.createElement('div'); el.className='tile'; el.textContent=t.shown; el.dataset.id=t.id; if(t.done) el.classList.add('hit'); el.onclick=()=>qfClick(el); grid.appendChild(el); });
}
function qfSetup(){ 
  QF.running=false; QF.t=60; QF.score=0; QF.hits=0; QF.prompt=null;
  if(QF.timer){clearInterval(QF.timer); QF.timer=null;}
  const pool=byCluster(DATA);
  if(!pool||pool.length===0){ $('qf-grid').innerHTML=''; $('qf-score').textContent='0'; $('qf-hits').textContent='0'; $('qf-timer').textContent='60'; $('qf-prompt').textContent='Nincs elég kártya ebben a témában.'; return; }
  QF.tiles=qfBuildTiles(); $('qf-score').textContent='0'; $('qf-hits').textContent='0'; $('qf-timer').textContent='60'; $('qf-prompt').textContent='Kezdéshez kattints a Start gombra.'; qfRenderGrid();
}
function qfNextPrompt(){ 
  const remaining=QF.tiles.filter(t=>!t.done);
  const cand=remaining.length? remaining : QF.tiles;
  const target = pick(cand); QF.prompt=target; $('qf-prompt').textContent=target.prompt;
}
function qfClick(el){ 
  if(!QF.running) return;
  const id=el.dataset.id;
  if(QF.prompt && QF.prompt.id===id){ el.classList.add('hit'); el.classList.remove('miss'); const tile=QF.tiles.find(t=>t.id===id); if(tile) tile.done=true; QF.score+=10; QF.hits++; $('qf-score').textContent=QF.score; $('qf-hits').textContent=QF.hits; qfNextPrompt(); }
  else { el.classList.add('miss'); setTimeout(()=>el.classList.remove('miss'),200); QF.score=Math.max(0,QF.score-2); $('qf-score').textContent=QF.score; }
}
function qfStart(){ 
  if(QF.timer){clearInterval(QF.timer); QF.timer=null;}
  if(!QF.tiles||QF.tiles.length===0){ qfSetup(); }
  QF.running=true; QF.t=60; QF.score=0; QF.hits=0; $('qf-score').textContent='0'; $('qf-hits').textContent='0'; $('qf-timer').textContent=QF.t; qfNextPrompt();
  QF.timer=setInterval(()=>{ QF.t--; $('qf-timer').textContent=QF.t; if(QF.t<=0){clearInterval(QF.timer); QF.timer=null; QF.running=false; $('qf-prompt').textContent='Vége! Pont: '+QF.score+' | Találat: '+QF.hits;} }, 1000);
}

/* =====================
   8) INIT & EVENTS
===================== */
function showErr(msg){const box=$('err'); box.textContent=msg; box.style.display='block';}
document.addEventListener('DOMContentLoaded',()=>{ 
  try{ 
    buildClusterSelect();
    flashBuildDeck(); matchNewRound(); mcNext(); qfSetup();
    $('cluster').addEventListener('change',()=>{ flashBuildDeck(); matchNewRound(); mcNext(); qfSetup(); });
    $('side').addEventListener('change',()=>{ renderFlash(); matchNewRound(); mcNext(); qfSetup(); });
    $('flash-flip').onclick=flashFlip; $('flash-know').onclick=flashKnow; $('flash-still').onclick=flashStill; $('flash-next').onclick=flashNext;
    $('reset').onclick=()=>{ const c=clusterSel(); if(c==='all'){ CLUSTERS.forEach(k=>localStorage.removeItem(lsKey(k))); } else { localStorage.removeItem(lsKey(c)); } flashBuildDeck(); refreshKnownCount(); };
    $('match-new').onclick=matchNewRound;
    $('mc-next').onclick=mcNext;
    $('qf-start').onclick=qfStart;
    $('tabs').addEventListener('click',(e)=>{ const t=e.target.closest('.tab'); if(!t) return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const id=t.dataset.tab; document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById('panel-'+id).classList.add('active'); if(id==='quick') qfSetup(); });
    window.addEventListener('keydown',(e)=>{ if(document.querySelector('.panel.active')?.id!=='panel-flash') return; const k=e.key.toLowerCase(); if(k==='f') document.getElementById('flash-flip').click(); if(k==='k') document.getElementById('flash-know').click(); if(k==='r') document.getElementById('flash-next').click(); });
  }catch(err){ showErr('JS error: '+err.message); console.error(err); }
});
</script>
</body>
</html>
